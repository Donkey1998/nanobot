## Context

nanobot 项目已有整体架构分析文档（[项目架构分析.md](项目架构分析.md)），但缺乏模块级别的详细学习文档。当前开发者若要深入理解特定模块，需要直接阅读源代码，学习曲线较陡。

本项目采用模块化架构，核心模块包括 Agent 循环、消息总线、工具系统、渠道管理器等 12 个主要组件。每个模块都有清晰的职责边界和设计理念，但这些知识隐式地存在于代码中，未显式记录。

**约束条件：**
- 零代码变更：仅添加文档，不修改任何源代码
- 文档需独立可读，不强制依赖其他模块文档
- 使用统一的文档结构，便于维护和扩展
- 文档使用中文编写，与项目现有文档风格一致

## Goals / Non-Goals

**Goals:**
- 为 12 个核心模块各生成一份完整的架构学习文档
- 每份文档包含设计理念、核心机制、关键接口、使用示例和扩展指南
- 生成索引文档，方便开发者快速定位和查找
- 提供代码位置引用，便于读者查阅源码

**Non-Goals:**
- 不修改现有代码结构或添加文档注释
- 不改变项目构建或部署流程
- 不生成 API 参考文档（那是另一类文档）
- 不覆盖第三方依赖库的文档

## Decisions

### D1: 文档结构模板

采用统一的六章节模板，确保所有模块文档结构一致：

1. **概述** - 模块简介、职责和定位
2. **设计理念** - 设计动机、原则和架构考量
3. **核心机制** - 工作原理、关键类和数据流
4. **关键接口** - 公共 API 和签名说明
5. **使用示例** - 实际代码示例和预期结果
6. **扩展指南** - 如何添加新功能（如适用）

**理由：** 统一结构便于读者快速定位信息，也便于跨模块比较。该结构覆盖了从理解到使用的完整学习路径。

### D2: 文档输出目录

文档放置在 `docs/architecture/modules/` 目录下，文件名使用模块名称的 kebab-case 格式：

```
docs/architecture/
├── MODULE_INDEX.md       # 索引文档
└── modules/
    ├── agent-loop.md
    ├── message-bus.md
    ├── tools-system.md
    └── ... (共 12 个模块文档)
```

**理由：** 与现有架构文档（`项目架构分析.md`）放在同一父目录下，便于关联。使用独立子目录避免文件过多。

### D3: 模块文档生成方式

采用**手动分析 + 代码引用**的方式生成文档：

1. 阅读模块源代码，理解其设计和工作原理
2. 提取关键类、函数和数据结构
3. 编写符合模板的文档内容
4. 添加源代码文件路径引用（使用相对路径）
5. 提供实际可运行的使用示例

**理由：** 本项目模块数量适中（12 个），手动分析可确保文档质量和准确性。自动生成工具可能无法捕捉隐式的设计理念。

### D4: 文档索引分类

索引文档将 12 个模块分为三类，并建议阅读顺序：

- **核心层**（4 个）：Agent 循环、消息总线、LLM 提供商、上下文构建器
- **功能层**（5 个）：工具系统、渠道管理器、浏览器自动化、会话管理、子 Agent 管理
- **支撑层**（3 个）：技能系统、定时任务、配置系统

**理由：** 分层分类帮助开发者建立系统视图，建议阅读顺序引导新手从核心到外围逐步理解。

### D5: 代码引用格式

文档中使用相对路径引用源代码，格式为：

```python
# 文件: agent/loop.py:42-58
def run_loop(self, max_iterations: int = 10):
    ...
```

**理由：** 相对路径在任何仓库副本中都有效，行号范围精确定位代码位置。

## Risks / Trade-offs

**风险 1：** 模块间依赖可能导致文档难以独立理解
**缓解措施：** 在每个文档中提供"相关模块"章节，用超链接链接到其他模块文档，但确保文档本身提供足够上下文

**风险 2：** 代码演进后文档可能过时
**缓解措施：** 在文档顶部添加"最后更新"日期，建议定期与代码同步；文档聚焦稳定的设计理念而非易变的实现细节

**风险 3：** 不同模块的复杂度差异大，统一模板可能不完全适用
**缓解措施：** 模板是指导性的，对于简单模块可适当精简，对于复杂模块可添加子章节

**权衡：** 手动生成文档耗时但质量高，自动生成快速但可能缺乏深度。本项目选择质量优先。

## Migration Plan

本变更是纯文档添加，无代码变更，无需迁移计划。

**部署步骤：**
1. 生成 12 个模块的架构文档
2. 生成索引文档
3. 提交到版本控制

**回滚策略：**
- 直接删除 `docs/architecture/modules/` 目录即可
- 不影响任何运行时代码

## Open Questions

无（本项目是纯文档生成任务，需求明确，无待解决的技术问题）
