# Design: Add Browser Control

## Context

当前 nanobot 仅支持通过 HTTP API 访问 Web 服务，无法处理需要浏览器环境的复杂交互场景。许多现代 Web 应用依赖 JavaScript 动态加载内容、使用复杂的认证流程（如扫码登录、OAuth）、或需要执行客户端代码才能访问完整功能。

**现有约束**：
- nanobot 是基于 Python 的 Agent 系统，采用 Tool 架构
- 配置系统基于 JSON schema，存储在 `~/.nanobot/config.json`
- 已有凭证管理机制（用于 API keys），需要与浏览器凭证统一管理
- 安全要求高（用户可能用于处理敏感信息如邮件）

**技术选型背景**：
- Playwright 是现代浏览器自动化的事实标准，支持多浏览器、稳定可靠
- Python keyring 库提供跨平台的系统密钥环访问
- 需要考虑与现有 Tool 体系的集成

## Goals / Non-Goals

**Goals:**
- 实现可靠的浏览器会话管理（启动、导航、停止、持久化）
- 提供结构化的页面快照，让 LLM 能够理解页面结构
- 实现点击、输入、等待等基础浏览器操作
- 支持多种登录策略（专用适配器、通用登录、手动登录）
- 通过白名单机制限制可访问域名
- 安全地存储和管理登录凭证
- 无缝集成到现有 Tool 体系

**Non-Goals:**
- 不实现完整的测试框架（虽然可以用 Playwright 做测试）
- 不支持多浏览器并行（初始版本仅支持单个浏览器实例）
- 不实现复杂的反爬虫对抗（如验证码识别、指纹伪装）
- 不支持浏览器集群或分布式操作
- 不实现网页录制或回放功能

## Decisions

### 1. 使用 Playwright 而非 Selenium

**决策**：选择 Playwright 作为浏览器自动化库。

**理由**：
- Playwright 提供更好的现代 Web 应用支持（自动等待、稳定的元素定位）
- 原生支持无头模式和跨浏览器（Chromium、Firefox、WebKit）
- 内置网络拦截、截图、PDF 导出等实用功能
- 更好的 Python API 设计和文档
- 活跃的维护和快速 bug 修复

**替代方案**：Selenium
- 优点：生态更成熟，支持更多浏览器
- 缺点：API 较老，需要更多手动等待逻辑，对现代 SPA 支持较差

### 2. 适配器模式处理登录

**决策**：采用三层登录策略（专用适配器 → 通用登录 → 手动登录）。

**理由**：
- **专用适配器**：高频网站（QQ 邮箱、Gmail）需要定制化逻辑保证高成功率
- **通用登录**：启发式规则可覆盖 60-70% 标准登录表单，降低开发成本
- **手动登录**：万能兜底，确保任何网站都能通过人工介入完成登录
- 可扩展：用户可添加自定义适配器

**替代方案**：纯 AI 驱动登录
- 优点：无需维护特定网站逻辑
- 缺点：成功率不稳定，成本高（每次登录都调用 LLM），难以调试

### 3. 使用系统密钥环（keyring）存储密码

**决策**：使用 keyring 库加密存储密码，不在配置文件中明文保存。

**理由**：
- 系统密钥环是操作系统级别的安全存储（macOS Keychain、Windows Credential Manager、Linux Secret Service）
- 用户已信任系统密钥环，无需额外安全措施
- 自动处理不同平台的差异

**替代方案**：自行加密存储（如使用 cryptography 库）
- 优点：完全控制，不依赖系统
- 缺点：需要管理加密密钥，更容易出错（密钥硬编码、弱加密）

### 4. URL 白名单机制

**决策**：通过 `allowedDomains` 白名单限制可访问域名。

**理由**：
- 防止 Agent 被诱导访问恶意网站（钓鱼、恶意脚本）
- 防止意外的资源消耗（访问大量网站）
- 用户显式授权，符合最小权限原则

**替代方案**：黑名单机制
- 优点：更灵活，允许访问任意网站
- 缺点：无法预知所有恶意域名，安全性差

### 5. ARIA 树作为页面快照主要数据源

**决策**：使用 Playwright 的 `accessibility_tree` API 提取页面结构。

**理由**：
- ARIA 树提供语义化的页面结构（角色、标签、状态）
- 包含可交互元素的完整信息（按钮、链接、表单字段）
- 天然支持无障碍标准，对 LLM 友好（结构化、有语义）
- 过滤噪音（隐藏元素、装饰性内容）

**替代方案**：完整 DOM 树
- 优点：信息更完整
- 缺点：包含大量噪音（div 嵌套、隐藏元素），对 LLM 不友好

### 6. 会话持久化到用户数据目录

**决策**：浏览器配置文件存储在 `~/.nanobot/browser-profiles/<domain>/`。

**理由**：
- 持久化 Cookie 和 LocalStorage，避免重复登录
- 隔离不同网站的配置文件，防止跨站污染
- 用户可手动备份或清理会话

**替代方案**：不持久化（每次启动新浏览器）
- 优点：更安全（无状态），避免会话劫持
- 缺点：每次都需要登录，用户体验差

## Risks / Trade-offs

### 风险 1：浏览器资源消耗

**风险**：Chromium 浏览器占用大量内存（~200-500MB），可能影响系统性能。

**缓解措施**：
- 默认使用无头模式（headless），减少 UI 开销
- 提供配置选项让用户禁用浏览器功能
- 文档中明确说明资源需求

### 风险 2：网站结构变化导致适配器失效

**风险**：网站更新 DOM 结构或登录流程，专用适配器可能失效。

**缓解措施**：
- 适配器使用稳定的定位策略（data-testid、ARIA 标签），而非脆弱的 CSS 选择器
- 实现适配器健康检查，登录失败时回退到通用/手动登录
- 提供适配器测试工具，方便用户验证和调试

### 风险 3：手动登录检测不可靠

**风险**：自动检测登录完成可能误判（如跳转到密码修改页面）。

**缓解措施**：
- 提供用户手动确认机制（"我已完成登录"按钮）
- 支持自定义登录完成条件（URL 模式、元素出现）
- 登录失败时提供清晰的错误信息和重试选项

### 风险 4：系统密钥环不可用

**风险**：某些环境（无头服务器、容器）可能没有系统密钥环。

**缓解措施**：
- keyring 库提供多种 backend，自动降级到文件存储
- 文档说明如何在服务器环境配置密钥环
- 提供禁用自动登录的选项

### 风险 5：跨平台兼容性

**风险**：Playwright 和 keyring 在不同平台行为可能有差异。

**缓解措施**：
- 在三大平台（Windows、macOS、Linux）上进行测试
- 使用 Playwright 的跨平台 API（避免平台特定功能）
- CI/CD 中包含多平台测试

## Migration Plan

### 部署步骤

1. **依赖安装**
   ```bash
   # 安装 Python 依赖
   pip install playwright keyring

   # 下载 Chromium 浏览器
   playwright install chromium
   ```

2. **配置启用**
   - 在 `~/.nanobot/config.json` 中添加 `browser.enabled: true`
   - 配置 `allowedDomains` 白名单

3. **迁移凭证（可选）**
   - 如果之前有明文存储的密码，运行迁移脚本加密存储
   - 迁移脚本：`nanobot migrate-credentials`

### 回滚策略

- 浏览器功能默认关闭，需要显式配置才启用
- 回滚只需设置 `browser.enabled: false`，不影响现有功能
- 浏览器数据独立存储，删除 `~/.nanobot/browser-profiles/` 即可清理

## Open Questions

### Q1: 是否需要支持多标签页？

**状态**：待决定

**背景**：某些场景可能需要同时打开多个标签页（如对比不同邮件）。

**选项**：
- A. 初始版本不支持，仅单标签页
- B. 支持多标签页，增加 API 复杂度

**建议**：初始版本采用 A，保持简单。后续根据需求添加。

### Q2: 如何处理动态内容的等待？

**状态**：部分决策

**背景**：SPA 应用内容异步加载，快照可能在内容加载前截取。

**当前方案**：
- Playwright 的 `wait_for_load_state("networkidle")` 等待网络空闲
- 额外提供可配置的等待时间

**待验证**：是否需要更智能的等待策略（如检测特定元素）。

### Q3: 是否需要支持浏览器扩展？

**状态**：待决定

**背景**：某些网站可能需要特定扩展（如广告拦截、翻译）。

**选项**：
- A. 不支持，保持简单
- B. 支持加载扩展，增加配置复杂度

**建议**：初始版本采用 A。如果有强烈需求，后续添加。

### Q4: 如何处理二进制文件下载？

**状态**：待决定

**背景**：Agent 可能需要下载文件（如邮件附件）。

**选项**：
- A. 使用 Playwright 的 download API，保存到临时目录
- B. 不处理，要求用户手动下载
- C. 提供下载链接，让用户用其他工具下载

**建议**：初始版本采用 A，集成到 BrowserTool 中。
